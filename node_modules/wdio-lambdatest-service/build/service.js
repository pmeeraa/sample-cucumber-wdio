"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _nodeRestClient = _interopRequireDefault(require("@lambdatest/node-rest-client"));

var _logger = _interopRequireDefault(require("@wdio/logger"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const log = (0, _logger.default)('@wdio/lambdatest-service');

class LambdaRestService {
  constructor() {
    this.testCnt = 0;
    this.failures = 0;
  }

  beforeSession(config, capabilities) {
    this.config = config;
    this.capabilities = capabilities;
    const lambdaCredentials = {
      username: this.config.user,
      accessKey: this.config.key,
      isApp: false
    };
    if (this.config.product === 'appAutomation') lambdaCredentials.isApp = true;

    if (this.config.logFile) {
      lambdaCredentials.logFile = this.config.logFile;
    }

    this.isServiceEnabled = lambdaCredentials.username && lambdaCredentials.accessKey;

    try {
      this.api = _nodeRestClient.default.AutomationClient(lambdaCredentials);
    } catch (_) {
      this.isServiceEnabled = false;
    }
  }

  beforeScenario(world, context) {
    if (!this.suiteTitle) {
      var _world$gherkinDocumen, _world$gherkinDocumen2, _context$document, _context$document$fea, _world$pickle;

      this.suiteTitle = (world === null || world === void 0 ? void 0 : (_world$gherkinDocumen = world.gherkinDocument) === null || _world$gherkinDocumen === void 0 ? void 0 : (_world$gherkinDocumen2 = _world$gherkinDocumen.feature) === null || _world$gherkinDocumen2 === void 0 ? void 0 : _world$gherkinDocumen2.name) || (context === null || context === void 0 ? void 0 : (_context$document = context.document) === null || _context$document === void 0 ? void 0 : (_context$document$fea = _context$document.feature) === null || _context$document$fea === void 0 ? void 0 : _context$document$fea.name) || (world === null || world === void 0 ? void 0 : (_world$pickle = world.pickle) === null || _world$pickle === void 0 ? void 0 : _world$pickle.name) || 'unknown scenario';
    }
  }

  beforeSuite(suite) {
    this.suiteTitle = suite.title;
  }

  beforeTest(test) {
    if (!this.isServiceEnabled) {
      return;
    }

    if (test.title && !this.testTitle) {
      this.testTitle = test.title;
    }

    if (this.suiteTitle === 'Jasmine__TopLevel__Suite') {
      const testSuiteName = test.fullName.slice(0, test.fullName.indexOf(test.description || '') - 1);
      this.suiteTitle = testSuiteName;
      global.browser.execute("lambda-name=" + this.suiteTitle);
    }
  }

  beforeStep(step) {
    if (!this.suiteTitle || this.suiteTitle == 'unknown scenario') {
      var _step$document, _step$document$featur, _step$step, _step$step$scenario;

      this.suiteTitle = (step === null || step === void 0 ? void 0 : (_step$document = step.document) === null || _step$document === void 0 ? void 0 : (_step$document$featur = _step$document.feature) === null || _step$document$featur === void 0 ? void 0 : _step$document$featur.name) || (step === null || step === void 0 ? void 0 : (_step$step = step.step) === null || _step$step === void 0 ? void 0 : (_step$step$scenario = _step$step.scenario) === null || _step$step$scenario === void 0 ? void 0 : _step$step$scenario.name) || 'unknown scenario';
    }
  }

  afterSuite(suite) {
    if (Object.prototype.hasOwnProperty.call(suite, 'error')) {
      ++this.failures;
    }
  }

  afterTest(test, context, {
    error,
    result,
    duration,
    passed,
    retries
  }) {
    console.log(error, result, duration, retries);

    if (!passed) {
      ++this.failures;
    }
  }

  afterScenario(world, {
    passed,
    error,
    duration
  }) {
    console.log(error, duration);

    if (!passed) {
      ++this.failures;
    }
  }

  after(result) {
    if (!this.isServiceEnabled) {
      return;
    }

    let failures = this.failures;
    console.log("Failure count captured", failures);

    if (global.browser.options.mochaOpts && global.browser.options.mochaOpts.bail && Boolean(result)) {
      failures = 1;
    }

    if (result === 0) {
      failures = 0;
    }

    const status = 'status: ' + (result > 0 ? 'failed' : 'passed');

    if (!global.browser.isMultiremote) {
      log.info(`Update job with sessionId ${global.browser.sessionId}, ${status}`);
      return this._update(global.browser.sessionId, result);
    }

    return Promise.all(Object.keys(this.capabilities).map(browserName => {
      log.info(`Update multiremote job for browser '${browserName}' and sessionId ${global.browser[browserName].sessionId}, ${status}`);
      return this._update(global.browser[browserName].sessionId, result, false, browserName);
    }));
  }

  onReload(oldSessionId, newSessionId) {
    if (!this.isServiceEnabled) {
      return;
    }

    const status = 'status: ' + (this.failures > 0 ? 'failed' : 'passed');

    if (!global.browser.isMultiremote) {
      log.info(`Update (reloaded) job with sessionId ${oldSessionId}, ${status}`);
      return this._update(oldSessionId, this.failures, true);
    }

    const browserName = global.browser.instances.filter(browserName => global.browser[browserName].sessionId === newSessionId)[0];
    log.info(`Update (reloaded) multiremote job for browser '${browserName}' and sessionId ${oldSessionId}, ${status}`);
    return this._update(oldSessionId, this.failures, true, browserName);
  }

  async _update(sessionId, failures, calledOnReload = false, browserName) {
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    await sleep(5000);
    return await this.updateJob(sessionId, failures, calledOnReload, browserName);
  }

  async updateJob(sessionId, failures, calledOnReload = false, browserName) {
    const body = this.getBody(failures, calledOnReload, browserName);

    try {
      await new Promise((resolve, reject) => {
        this.api.updateSessionById(sessionId, body, (err, result) => {
          if (err) {
            return reject(err);
          }

          return resolve(result);
        });
      });
    } catch (ex) {
      console.log(ex);
    }

    this.failures = 0;
  }

  getBody(failures, calledOnReload = false, browserName) {
    let body = {};

    if (!(!global.browser.isMultiremote && this.capabilities.name || global.browser.isMultiremote && this.capabilities[browserName].capabilities.name)) {
      let testName = this.suiteTitle;
      body.name = testName;

      if (this.capabilities['LT:Options'] && this.capabilities['LT:Options'].name) {
        body.name = this.capabilities['LT:Options'].name;
      }

      if (browserName) {
        body.name = `${browserName}: ${body.name}`;
      }

      if (calledOnReload || this.testCnt) {
        let testCnt = ++this.testCnt;

        if (global.browser.isMultiremote) {
          testCnt = Math.ceil(testCnt / global.browser.instances.length);
        }

        body.name += ` (${testCnt})`;
      }
    }

    body.status_ind = failures > 0 ? 'failed' : 'passed';
    return body;
  }

}

exports.default = LambdaRestService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJsb2ciLCJsb2dnZXIiLCJMYW1iZGFSZXN0U2VydmljZSIsImNvbnN0cnVjdG9yIiwidGVzdENudCIsImZhaWx1cmVzIiwiYmVmb3JlU2Vzc2lvbiIsImNvbmZpZyIsImNhcGFiaWxpdGllcyIsImxhbWJkYUNyZWRlbnRpYWxzIiwidXNlcm5hbWUiLCJ1c2VyIiwiYWNjZXNzS2V5Iiwia2V5IiwiaXNBcHAiLCJwcm9kdWN0IiwibG9nRmlsZSIsImlzU2VydmljZUVuYWJsZWQiLCJhcGkiLCJMYW1iZGFSZXN0Q2xpZW50IiwiQXV0b21hdGlvbkNsaWVudCIsIl8iLCJiZWZvcmVTY2VuYXJpbyIsIndvcmxkIiwiY29udGV4dCIsInN1aXRlVGl0bGUiLCJnaGVya2luRG9jdW1lbnQiLCJmZWF0dXJlIiwibmFtZSIsImRvY3VtZW50IiwicGlja2xlIiwiYmVmb3JlU3VpdGUiLCJzdWl0ZSIsInRpdGxlIiwiYmVmb3JlVGVzdCIsInRlc3QiLCJ0ZXN0VGl0bGUiLCJ0ZXN0U3VpdGVOYW1lIiwiZnVsbE5hbWUiLCJzbGljZSIsImluZGV4T2YiLCJkZXNjcmlwdGlvbiIsImdsb2JhbCIsImJyb3dzZXIiLCJleGVjdXRlIiwiYmVmb3JlU3RlcCIsInN0ZXAiLCJzY2VuYXJpbyIsImFmdGVyU3VpdGUiLCJPYmplY3QiLCJwcm90b3R5cGUiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiLCJhZnRlclRlc3QiLCJlcnJvciIsInJlc3VsdCIsImR1cmF0aW9uIiwicGFzc2VkIiwicmV0cmllcyIsImNvbnNvbGUiLCJhZnRlclNjZW5hcmlvIiwiYWZ0ZXIiLCJvcHRpb25zIiwibW9jaGFPcHRzIiwiYmFpbCIsIkJvb2xlYW4iLCJzdGF0dXMiLCJpc011bHRpcmVtb3RlIiwiaW5mbyIsInNlc3Npb25JZCIsIl91cGRhdGUiLCJQcm9taXNlIiwiYWxsIiwia2V5cyIsIm1hcCIsImJyb3dzZXJOYW1lIiwib25SZWxvYWQiLCJvbGRTZXNzaW9uSWQiLCJuZXdTZXNzaW9uSWQiLCJpbnN0YW5jZXMiLCJmaWx0ZXIiLCJjYWxsZWRPblJlbG9hZCIsInNsZWVwIiwibXMiLCJyIiwic2V0VGltZW91dCIsInVwZGF0ZUpvYiIsImJvZHkiLCJnZXRCb2R5IiwicmVzb2x2ZSIsInJlamVjdCIsInVwZGF0ZVNlc3Npb25CeUlkIiwiZXJyIiwiZXgiLCJ0ZXN0TmFtZSIsIk1hdGgiLCJjZWlsIiwibGVuZ3RoIiwic3RhdHVzX2luZCJdLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBMYW1iZGFSZXN0Q2xpZW50IGZyb20gJ0BsYW1iZGF0ZXN0L25vZGUtcmVzdC1jbGllbnQnXG5pbXBvcnQgbG9nZ2VyIGZyb20gJ0B3ZGlvL2xvZ2dlcidcblxuY29uc3QgbG9nID0gbG9nZ2VyKCdAd2Rpby9sYW1iZGF0ZXN0LXNlcnZpY2UnKVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBMYW1iZGFSZXN0U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMudGVzdENudCA9IDA7XG4gICAgdGhpcy5mYWlsdXJlcyA9IDA7XG4gIH1cblxuICBiZWZvcmVTZXNzaW9uKGNvbmZpZywgY2FwYWJpbGl0aWVzKSB7XG4gICAgdGhpcy5jb25maWcgPSBjb25maWc7XG4gICAgdGhpcy5jYXBhYmlsaXRpZXMgPSBjYXBhYmlsaXRpZXM7XG4gICAgY29uc3QgbGFtYmRhQ3JlZGVudGlhbHMgPSB7XG4gICAgICB1c2VybmFtZTogdGhpcy5jb25maWcudXNlcixcbiAgICAgIGFjY2Vzc0tleTogdGhpcy5jb25maWcua2V5LFxuICAgICAgaXNBcHAgOiBmYWxzZVxuICAgIH07XG5cbiAgICBpZiAodGhpcy5jb25maWcucHJvZHVjdCA9PT0gJ2FwcEF1dG9tYXRpb24nKSBsYW1iZGFDcmVkZW50aWFscy5pc0FwcCA9dHJ1ZVxuXG4gICAgaWYgKHRoaXMuY29uZmlnLmxvZ0ZpbGUpIHtcbiAgICAgIGxhbWJkYUNyZWRlbnRpYWxzLmxvZ0ZpbGUgPSB0aGlzLmNvbmZpZy5sb2dGaWxlO1xuICAgIH1cblxuICAgIHRoaXMuaXNTZXJ2aWNlRW5hYmxlZCA9IGxhbWJkYUNyZWRlbnRpYWxzLnVzZXJuYW1lICYmIGxhbWJkYUNyZWRlbnRpYWxzLmFjY2Vzc0tleTtcblxuICAgIHRyeSB7XG4gICAgICB0aGlzLmFwaSA9IExhbWJkYVJlc3RDbGllbnQuQXV0b21hdGlvbkNsaWVudChsYW1iZGFDcmVkZW50aWFscyk7XG4gICAgfSBjYXRjaCAoXykge1xuICAgICAgdGhpcy5pc1NlcnZpY2VFbmFibGVkID0gZmFsc2U7XG4gICAgfVxuICB9XG4gIGJlZm9yZVNjZW5hcmlvKHdvcmxkLCBjb250ZXh0KSB7XG4gICAgaWYgKCF0aGlzLnN1aXRlVGl0bGUpe1xuICAgICAgdGhpcy5zdWl0ZVRpdGxlID0gd29ybGQ/LmdoZXJraW5Eb2N1bWVudD8uZmVhdHVyZT8ubmFtZXx8IGNvbnRleHQ/LmRvY3VtZW50Py5mZWF0dXJlPy5uYW1lIHx8IHdvcmxkPy5waWNrbGU/Lm5hbWUgfHwgJ3Vua25vd24gc2NlbmFyaW8nO1xuICAgIH1cbiAgfVxuXG4gIGJlZm9yZVN1aXRlKHN1aXRlKSB7XG4gICAgdGhpcy5zdWl0ZVRpdGxlID0gc3VpdGUudGl0bGU7XG4gIH1cblxuICBiZWZvcmVUZXN0KHRlc3QpIHtcbiAgICBpZiAoIXRoaXMuaXNTZXJ2aWNlRW5hYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGVzdC50aXRsZSAmJiAhdGhpcy50ZXN0VGl0bGUpe1xuICAgICAgdGhpcy50ZXN0VGl0bGUgPSB0ZXN0LnRpdGxlXG4gICAgfVxuICAgIFxuICAgIGlmICh0aGlzLnN1aXRlVGl0bGUgPT09ICdKYXNtaW5lX19Ub3BMZXZlbF9fU3VpdGUnKSB7XG4gICAgICBjb25zdCB0ZXN0U3VpdGVOYW1lID0gdGVzdC5mdWxsTmFtZS5zbGljZSgwLCB0ZXN0LmZ1bGxOYW1lLmluZGV4T2YodGVzdC5kZXNjcmlwdGlvbiB8fCAnJykgLSAxKVxuICAgICAgdGhpcy5zdWl0ZVRpdGxlID0gdGVzdFN1aXRlTmFtZTtcbiAgICAgIGdsb2JhbC5icm93c2VyLmV4ZWN1dGUoXCJsYW1iZGEtbmFtZT1cIit0aGlzLnN1aXRlVGl0bGUpXG4gICAgfVxuICB9XG5cbiAgYmVmb3JlU3RlcChzdGVwKSB7XG4gICAgaWYgKCF0aGlzLnN1aXRlVGl0bGUgfHwgdGhpcy5zdWl0ZVRpdGxlID09ICd1bmtub3duIHNjZW5hcmlvJykge1xuICAgICAgdGhpcy5zdWl0ZVRpdGxlID0gc3RlcD8uZG9jdW1lbnQ/LmZlYXR1cmU/Lm5hbWUgfHwgc3RlcD8uc3RlcD8uc2NlbmFyaW8/Lm5hbWUgfHwgJ3Vua25vd24gc2NlbmFyaW8nO1xuICAgIH1cbiAgfVxuXG4gIGFmdGVyU3VpdGUoc3VpdGUpIHtcbiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHN1aXRlLCAnZXJyb3InKSkge1xuICAgICAgKyt0aGlzLmZhaWx1cmVzO1xuICAgIH1cbiAgfVxuXG4gIGFmdGVyVGVzdCh0ZXN0LCBjb250ZXh0LCB7XG4gICAgZXJyb3IsXG4gICAgcmVzdWx0LFxuICAgIGR1cmF0aW9uLFxuICAgIHBhc3NlZCxcbiAgICByZXRyaWVzXG4gIH0pIHtcbiAgICBjb25zb2xlLmxvZyhlcnJvciwgcmVzdWx0LCBkdXJhdGlvbiwgcmV0cmllcylcbiAgICBpZiAoIXBhc3NlZCkge1xuICAgICAgKyt0aGlzLmZhaWx1cmVzO1xuICAgIH1cbiAgfVxuXG4gIGFmdGVyU2NlbmFyaW8od29ybGQsIHsgcGFzc2VkLCBlcnJvciwgZHVyYXRpb24gfSkge1xuICAgIGNvbnNvbGUubG9nKGVycm9yLCBkdXJhdGlvbilcbiAgICBpZiAoIXBhc3NlZCkge1xuICAgICAgKyt0aGlzLmZhaWx1cmVzO1xuICAgIH1cbiAgfVxuXG4gIGFmdGVyKHJlc3VsdCkge1xuICAgIGlmICghdGhpcy5pc1NlcnZpY2VFbmFibGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbGV0IGZhaWx1cmVzID0gdGhpcy5mYWlsdXJlcztcblxuICAgIGNvbnNvbGUubG9nKFwiRmFpbHVyZSBjb3VudCBjYXB0dXJlZFwiLCBmYWlsdXJlcylcblxuICAgIGlmIChnbG9iYWwuYnJvd3Nlci5vcHRpb25zLm1vY2hhT3B0cyAmJiBnbG9iYWwuYnJvd3Nlci5vcHRpb25zLm1vY2hhT3B0cy5iYWlsICYmIEJvb2xlYW4ocmVzdWx0KSkge1xuICAgICAgZmFpbHVyZXMgPSAxO1xuICAgIH1cbiAgICBcbiAgICBpZiAocmVzdWx0ID09PSAwKSB7XG4gICAgICBmYWlsdXJlcyA9IDA7XG4gICAgfVxuICAgIGNvbnN0IHN0YXR1cyA9ICdzdGF0dXM6ICcgKyAocmVzdWx0ID4gMCA/ICdmYWlsZWQnIDogJ3Bhc3NlZCcpO1xuXG4gICAgaWYgKCFnbG9iYWwuYnJvd3Nlci5pc011bHRpcmVtb3RlKSB7XG4gICAgICBsb2cuaW5mbyhgVXBkYXRlIGpvYiB3aXRoIHNlc3Npb25JZCAke2dsb2JhbC5icm93c2VyLnNlc3Npb25JZH0sICR7c3RhdHVzfWApO1xuICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZShnbG9iYWwuYnJvd3Nlci5zZXNzaW9uSWQsIHJlc3VsdCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIFByb21pc2UuYWxsKE9iamVjdC5rZXlzKHRoaXMuY2FwYWJpbGl0aWVzKS5tYXAoYnJvd3Nlck5hbWUgPT4ge1xuICAgICAgbG9nLmluZm8oYFVwZGF0ZSBtdWx0aXJlbW90ZSBqb2IgZm9yIGJyb3dzZXIgJyR7YnJvd3Nlck5hbWV9JyBhbmQgc2Vzc2lvbklkICR7Z2xvYmFsLmJyb3dzZXJbYnJvd3Nlck5hbWVdLnNlc3Npb25JZH0sICR7c3RhdHVzfWApO1xuICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZShnbG9iYWwuYnJvd3Nlclticm93c2VyTmFtZV0uc2Vzc2lvbklkLCByZXN1bHQsIGZhbHNlLCBicm93c2VyTmFtZSk7XG4gICAgfSkpO1xuICB9XG5cbiAgb25SZWxvYWQob2xkU2Vzc2lvbklkLCBuZXdTZXNzaW9uSWQpIHtcbiAgICBpZiAoIXRoaXMuaXNTZXJ2aWNlRW5hYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHN0YXR1cyA9ICdzdGF0dXM6ICcgKyAodGhpcy5mYWlsdXJlcyA+IDAgPyAnZmFpbGVkJyA6ICdwYXNzZWQnKTtcblxuICAgIGlmICghZ2xvYmFsLmJyb3dzZXIuaXNNdWx0aXJlbW90ZSkge1xuICAgICAgbG9nLmluZm8oYFVwZGF0ZSAocmVsb2FkZWQpIGpvYiB3aXRoIHNlc3Npb25JZCAke29sZFNlc3Npb25JZH0sICR7c3RhdHVzfWApO1xuICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZShvbGRTZXNzaW9uSWQsIHRoaXMuZmFpbHVyZXMsIHRydWUpO1xuICAgIH1cblxuICAgIGNvbnN0IGJyb3dzZXJOYW1lID0gZ2xvYmFsLmJyb3dzZXIuaW5zdGFuY2VzLmZpbHRlcihicm93c2VyTmFtZSA9PiBnbG9iYWwuYnJvd3Nlclticm93c2VyTmFtZV0uc2Vzc2lvbklkID09PSBuZXdTZXNzaW9uSWQpWzBdO1xuICAgIGxvZy5pbmZvKGBVcGRhdGUgKHJlbG9hZGVkKSBtdWx0aXJlbW90ZSBqb2IgZm9yIGJyb3dzZXIgJyR7YnJvd3Nlck5hbWV9JyBhbmQgc2Vzc2lvbklkICR7b2xkU2Vzc2lvbklkfSwgJHtzdGF0dXN9YCk7XG4gICAgcmV0dXJuIHRoaXMuX3VwZGF0ZShvbGRTZXNzaW9uSWQsIHRoaXMuZmFpbHVyZXMsIHRydWUsIGJyb3dzZXJOYW1lKTtcbiAgfVxuXG4gIGFzeW5jIF91cGRhdGUgKCBzZXNzaW9uSWQsIGZhaWx1cmVzLCBjYWxsZWRPblJlbG9hZCA9IGZhbHNlLCBicm93c2VyTmFtZSApIHtcbiAgICBjb25zdCBzbGVlcCA9IG1zID0+IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCBtcykpO1xuICAgIFxuICAgIGF3YWl0IHNsZWVwKDUwMDApXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudXBkYXRlSm9iKHNlc3Npb25JZCwgZmFpbHVyZXMsIGNhbGxlZE9uUmVsb2FkLCBicm93c2VyTmFtZSk7XG4gIH1cblxuICBhc3luYyB1cGRhdGVKb2Ioc2Vzc2lvbklkLCBmYWlsdXJlcywgY2FsbGVkT25SZWxvYWQgPSBmYWxzZSwgYnJvd3Nlck5hbWUpIHtcbiAgICBjb25zdCBib2R5ID0gdGhpcy5nZXRCb2R5KGZhaWx1cmVzLCBjYWxsZWRPblJlbG9hZCwgYnJvd3Nlck5hbWUpO1xuICAgIHRyeXtcbiAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmFwaS51cGRhdGVTZXNzaW9uQnlJZChzZXNzaW9uSWQsIGJvZHksIChlcnIsIHJlc3VsdCkgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc29sdmUocmVzdWx0KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG4gIGNhdGNoKGV4KXtcbiAgICBjb25zb2xlLmxvZyhleCk7XG4gIH1cbiAgICB0aGlzLmZhaWx1cmVzID0gMDtcbiAgfVxuXG4gIGdldEJvZHkoZmFpbHVyZXMsIGNhbGxlZE9uUmVsb2FkID0gZmFsc2UsIGJyb3dzZXJOYW1lKSB7XG4gICAgbGV0IGJvZHkgPSB7fTtcbiAgICBpZiAoISghZ2xvYmFsLmJyb3dzZXIuaXNNdWx0aXJlbW90ZSAmJiB0aGlzLmNhcGFiaWxpdGllcy5uYW1lIHx8IGdsb2JhbC5icm93c2VyLmlzTXVsdGlyZW1vdGUgJiYgdGhpcy5jYXBhYmlsaXRpZXNbYnJvd3Nlck5hbWVdLmNhcGFiaWxpdGllcy5uYW1lKSkge1xuICAgICAgbGV0IHRlc3ROYW1lID0gdGhpcy5zdWl0ZVRpdGxlXG4gICAgICBcbiAgICAgIGJvZHkubmFtZSA9IHRlc3ROYW1lXG4gICAgICBcbiAgICAgIGlmICh0aGlzLmNhcGFiaWxpdGllc1snTFQ6T3B0aW9ucyddICYmIHRoaXMuY2FwYWJpbGl0aWVzWydMVDpPcHRpb25zJ10ubmFtZSl7XG4gICAgICAgIGJvZHkubmFtZSA9IHRoaXMuY2FwYWJpbGl0aWVzWydMVDpPcHRpb25zJ10ubmFtZVxuICAgICAgfVxuICAgICAgXG4gICAgICBpZiAoYnJvd3Nlck5hbWUpIHtcbiAgICAgICAgYm9keS5uYW1lID0gYCR7YnJvd3Nlck5hbWV9OiAke2JvZHkubmFtZX1gO1xuICAgICAgfVxuXG4gICAgICBpZiAoY2FsbGVkT25SZWxvYWQgfHwgdGhpcy50ZXN0Q250KSB7XG4gICAgICAgIGxldCB0ZXN0Q250ID0gKyt0aGlzLnRlc3RDbnQ7XG5cbiAgICAgICAgaWYgKGdsb2JhbC5icm93c2VyLmlzTXVsdGlyZW1vdGUpIHtcbiAgICAgICAgICB0ZXN0Q250ID0gTWF0aC5jZWlsKHRlc3RDbnQgLyBnbG9iYWwuYnJvd3Nlci5pbnN0YW5jZXMubGVuZ3RoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGJvZHkubmFtZSArPSBgICgke3Rlc3RDbnR9KWA7XG4gICAgICB9XG4gICAgfVxuXG4gICAgYm9keS5zdGF0dXNfaW5kID0gZmFpbHVyZXMgPiAwID8gJ2ZhaWxlZCcgOiAncGFzc2VkJztcbiAgICByZXR1cm4gYm9keTtcbiAgfVxuXG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOzs7O0FBRUEsTUFBTUEsR0FBRyxHQUFHLElBQUFDLGVBQUEsRUFBTywwQkFBUCxDQUFaOztBQUVlLE1BQU1DLGlCQUFOLENBQXdCO0VBQ3JDQyxXQUFXLEdBQUc7SUFDWixLQUFLQyxPQUFMLEdBQWUsQ0FBZjtJQUNBLEtBQUtDLFFBQUwsR0FBZ0IsQ0FBaEI7RUFDRDs7RUFFREMsYUFBYSxDQUFDQyxNQUFELEVBQVNDLFlBQVQsRUFBdUI7SUFDbEMsS0FBS0QsTUFBTCxHQUFjQSxNQUFkO0lBQ0EsS0FBS0MsWUFBTCxHQUFvQkEsWUFBcEI7SUFDQSxNQUFNQyxpQkFBaUIsR0FBRztNQUN4QkMsUUFBUSxFQUFFLEtBQUtILE1BQUwsQ0FBWUksSUFERTtNQUV4QkMsU0FBUyxFQUFFLEtB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